{% extends 'layout/layout.html' %}

{% load helper_tags %}

{% block content %}

{% load static %}

{% block style %} {% endblock %}

<div class="row" id="containerHeight">
    <div class="col-md-12 pr-md-0 h-100">
        <div class="primaryContainer h-100" id="mainbox">
            <div class="row mb-2" id="topRow">
                <div class="col-md-5 p-md-0">
                    <h6><b>{{page_title}} &nbsp;&nbsp;</b><span class="fa fa-star add_to_fav {% checkedFavorite page_title request.get_full_path %}" onclick="updateFavorite(this,'{{page_title}}','{{ request.get_full_path }}')"></span></h6>
                </div>
                <div class="col-md-7 p-md-0">
                    <div class="row mb-2 mt-2" id="secondRow">
                        <div class="col-md-12 p-md-0 text-right">
                            
                        </div>
                    </div>
                </div>
            </div>
            <form id="BMCForm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-12 primaryContainerBG h-100 p-10 commonTableBg">
                        <div class="row">
                            <div class="col-md-8 text-left">
                                <div class="row">
                                    <div class="col-md-3 form-group text-left" id="import_file_div">
                                        <label>Import file</label>
                                        <input type="file" name="bmc_sheet" id="bmc_sheet"  class="inputField" onchange="filesUploader(this.id,'', 'File', 'bmc_sheet_error')" required/>
                                        <span id="bmc_sheet_error" style="color: red; font-size: 11px;"></span>
                                    </div>
                                    <div class="col-md-1 form-group text-left" style="margin-top: 30px;">
                                        <input type="submit" class="btn btn-primary import_button" value="Upload"/>
                                        <input type="button" id="export_button" class="btn btn-primary" onclick="exportBMCExcel()" value="Export" style="display: none;">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 text-right">
                                
                                {% if excel_data %}
                                {% if invalid_data == 0 %}
                                <button class="btn btn-save float-right" id="updateBtn" type="button" onclick="uploadBMC()">Save</button>
                                {% endif %}
                                <button class="btn btn-close float-right" id="cancelBtn" type="button" onclick="cancel()" >Close</button>
                                {% else %}
                                 <button class="btn iconBox iconExportExcel"  id="exportBtn" type="button" onclick="exportExcelBMC()" ></button>
                                {% comment %} <a href="/excel-templates/incentive-excel.xlsx" type="button" id="" class="btn iconBox iconExportExcel"  download=""></a> {% endcomment %}
                                {% endif %}
                            </div>
                        </div>
                        <div class="row" style="margin-top:10px;">
                            <div class="table-responsive">
                                <table class="table" id="addOrgTable">
                                    <thead>
                                        <tr>
                                            <th>BMC CODE</th>
                                            <th>BMC NAME</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if excel_data %}
                                        {% for bmc_list in excel_data %}
                                        <tr>
                                            <td>{{bmc_list.bmc_code}} {% if bmc_list.bmc_code_blank_temp %} <span style="color: red;">({{bmc_list.bmc_code_blank_temp}})</span> {% elif bmc_list.bmc_code_temp %} <span style="color: red;">({{bmc_list.bmc_code_temp}})</span>{% else %}<span style="color: green;">({{bmc_list.bmc_code}})</span>{% endif %}<input type="hidden" name="bmc_code[]" value="{{bmc_list.bmc_code}}"></td>
                                            <td>{{bmc_list.bmc_name}} {% if bmc_list.bmc_name_blank_temp %} <span style="color: red;">({{bmc_list.bmc_name_blank_temp}})</span> {% else %}{% endif %}<input type="hidden" name="bmc_name[]" value="{{bmc_list.bmc_name}}"></td>
                                        </tr>
                                        {% endfor %}
                                        
                                        {% else %}
                                        <tr>
                                            <td colspan="2">Please upload BMC excel to preview data.</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
            </form>
        </div>
    </div>
    
</div>


{% endblock content %}
{% block script %}
<script>
    
   function exportExcelBMC(){
        window.location.href = "{% url 'src:export-BMC-Excel' %}";
    } 
    function uploadBMC(){
        showLoader();
        $.ajax({
            url: "{% url 'src:upload-bmc' %}",
            method: 'POST',
            data: $('#BMCForm').serialize(),
            success: function (data) {
                hideLoader();
                if(data.flag){
                    openToaster("success", data.message);
                    setTimeout(function(){ window.location.reload(); }, 10);
                }else{
                    openToaster("danger", data.message);
                }
            },
            error: function (err) {
                hideLoader();
                console.log(err)
            }
        }).always(function() {
            hideLoader();
        });
        
    }
    function cancel(){
        window.location.href = "{% url 'src:import-bmc' %}";
    }

 
    function filesUploader(id, previewId, fileType, error_id) {
        for (var i = 0; i < $("#"+id).get(0).files.length; ++i) {
            var file1=$("#"+id).get(0).files[i].name;
            var error = 0;
            document.getElementById(error_id).innerHTML = '';
            
            if(file1){                     
                var ext = file1.split('.').pop().toLowerCase(); 
                if($.inArray(ext,['xlsx'])===-1){
                    error = 1;   
                    document.getElementById(error_id).innerHTML = ''+fileType+' should be excel(xlsx)*';
                    
                    // $("#"+previewId).attr("src", "/static/img/svg/PANGrey.svg");
                    $("#"+id).val('');
                }else{
                    error = 0;
                }                        
            } else {
                error = 0;
            }
        }
        
    }

    function showHide(type){
        if(type == '0'){
            $('#import_file_div').show();
            $('.import_button').show();
            $('#export_button').hide();
        }else{
            $('#import_file_div').hide();
            $('.import_button').hide();
            $('#export_button').show();
        }
    };

   
</script>
{% endblock %}
