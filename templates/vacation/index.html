{% extends 'layout/layout.html' %}

{% load helper_tags %}

{% block content %}

{% load static %}

{% block style %} 
<style>
    .ui-autocomplete {
        max-height: 100px !important;
        overflow-y: auto !important;
        /* prevent horizontal scrollbar */
        overflow-x: hidden !important;
    }
    /* IE 6 doesn't support max-height
    * we use height instead, but this forces the menu to always be this tall
    */
    * html .ui-autocomplete {
        height: 100px !important;
    }
    
    /* calendar css start */
    .calendar {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    .calendar__input {
        display: none;
    }
    
    .calendar__label {
        display: block;
    }
    
    .calendar__label__day {
        padding-bottom: 0.4rem;
        background-color: white;
        font-size: 0.8rem;
    }
    
    /* calendar css start */
    
    
</style>
<link rel="stylesheet" href="{% static 'css/jquery-confirm.min.css' %}">
<link rel="stylesheet" href="{% static 'css/vacations.css' %}">
<link rel="stylesheet" href="{% static 'css/vacations.css' %}">
<link rel="stylesheet" href="{% static 'css/manage-holidays.css' %}">
{% endblock %}

<div class="row" id="containerHeight">
    <div class="col-md-8 pr-md-0 h-100">
        <div class="primaryContainer h-100" id="mainbox" style="background-color: #ffffff;">
            <div class="row mb-2" id="topRow" style="background-color: #f7f8fb;">
                <div class="col-md-5 p-md-0">
                    <h6><b>{{page_title}} &nbsp;&nbsp;</b><span class="fa fa-star add_to_fav {% checkedFavorite page_title request.get_full_path %}" onclick="updateFavorite(this,'{{page_title}}','{{ request.get_full_path }}')"></span></h6>
                </div>
                <div class="col-md-7 p-md-0">
                    <div class="row">
                    </div>
                    <div class="row mb-2 mt-2" id="secondRow">
                        <div class="col-md-12 px-0 ">
                            
                        </div>
                    </div>
                </div>
            </div>
            {% if holiday %}
            
            <div class="primaryContainerBG h-100" id="ajaxCalendarDiv">
                <form action="" id="markVacationForm">
                    <div class="row">
                        <div class="col-md-6 px-0">
                            <div class="row">
                                <span class="slider-icon-box"onclick="getVacationCalender('{{ holiday.id }}','{{previous_month}}','{{current_year}}')">
                                    <img src="{% static 'img/svg/arrow_left.svg' %}" alt="">
                                </span>
                                <span class="calendar-title">{{current_month_name}} 
                                    <b style="color: #000;">{{current_year}}</b>
                                </span>
                                <span class="slider-icon-box mr-3" onclick="getVacationCalender('{{ holiday.id }}','{{next_month}}','{{current_year}}')"> 
                                    <img src="{% static 'img/svg/arrow_right.svg' %}" alt="">
                                </span>
                                <div class="border-left ">
                                    <span class="d-block   customer-name">
                                        {{ customer.first_name }}{% if customer.middle_name is not None %} {{ customer.middle_name }} {% endif %}{{ customer.last_name }}
                                    </span> 
                                    <span class="d-block  emp-sap-id">{{ customer.emp_sap_id }}</span>
                                </div>
                            </div>
                        </div>                       
                        
                        <div class="col-md-12 px-0 calendar-table">
                            <table class="">
                                <thead>
                                    <tr>
                                        <th>Monday</th>
                                        <th>Tuesday</th>
                                        <th>Wednesday</th>
                                        <th>Thursday</th>
                                        <th>Friday</th>
                                        <th>Saturday</th>
                                        <th>Sunday</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for calendar_date in calendar_dates %}
                                    <tr>
                                        {% for data in calendar_date %}
                                        {{ data.holidayDate }}
                                        <td class=" ">
                                            
                                            {% if data.short_date in data.holidayDate %}
                                            <input type="checkbox" name="" id="date-2021-03-01" value="2021-03-01" onclick="" class="calendar__input" disabled="">
                                            <label for="date-2021-03-01" class="calendar__label disabled_date">
                                            <div class="calendar__label__date" style="background-color: green; color: white;">
                                                {{data.short_date }}<br> {{data.holidayName}}
                                               
                                            </div>

                                            {% elif data.short_date != data.holidayDate %}
                                            <input type="checkbox" name="" id="date-2021-03-01" value="2021-03-01" onclick="" class="calendar__input" disabled="">
                                            <label for="date-2021-03-01" class="calendar__label disabled_date">
                                            <div class="calendar__label__date">
                                                {{data.short_date }}
                                               
                                            </div>
                                            {% endif %}   
                                            </label>
                                        </td>                                        
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                    
                                </tbody>
                            </table>
                            
                        </div>
                    </div>
                </form>
            </div>
            {% else %}
            <div class="primaryContainerBG h-100 calender-container" id="ajaxCalendarDiv">
            </div>
            {% endif %}
            
        </div>
    </div>
    <div class="col-md-4 col-12 pl-3 pr-0 h-100">
        <div class="primaryContainerBG h-100" id="detailsBox">
            <div class="row" id="tableBox" style="display: block;">
                <div class="col-sm-12 col-12 px-0 mb-2">
                    <div class="row">
                        <div class="col-sm-7 col-7 px-0">
                            <input class="searchTable w-100" placeholder="Search" type="text" id="filter_search" onkeyup="filterVacationList()" data-column="all">
                        </div>
                        <div class="col-sm-5 col-5 px-0">
                        <button type="button" class="btn-2blue font-13 float-right" id="AddnewHolidayModal">Add New
                        </button>
                    </div>
                        <!-- <div class="col-sm-5 col-5 pl-2 pr-0">     
                            <select class="inputField selectField w-100" name="" id="filter_locality_id" onchange="filterVacationList()">
                                <option value="">All Locality</option>
                                {% for locality in localities %}
                                <option value="{{locality.id}}">{{locality.town}}</option>
                                {% endfor %}
                            </select>
                        </div> -->
                    </div>
                </div>
                
                <div class="col-sm-12 col-12 primaryContainerBG h-100 p-0 commonTableBg" id="ajax-div">
                    <input type="hidden" name="page" id="page" value="2" />
                    <input type="hidden" name="page_status" id="page_status" value="0" />
                    <input type="hidden" name="total_pages" id="total_pages" value="{{ total_pages }}" />
                    <table id="addOrgTable" class="table table-borderless table-striped table-hover mt-0" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Holiday</th>
                                <th>Holiday Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="tablebody">
                            {% if holidays %}
                            {% for holiday in holidays %}
                            <tr  {% if forloop.first %} class="odd selected" {% endif %}>
                                <td onclick="getVacationCalender('{{ holiday_type.id }}','{{current_month}}','{{current_year}}')">{{ holiday.holiday }}
                                    
                                    <br>
                                </td>
                                <td onclick="getVacationCalender('{{ holiday.id }}','{{current_month}}','{{current_year}}')">{{holiday.holiday_type}}</td>
                                <td onclick="getVacationCalender('{{ holiday.id }}','{{current_month}}','{{current_year}}')">
                                    {{ holiday.description}}
                                </td>                                
                            </tr>
                                {% endfor %}
                                <tr id="loading" style="display: none;">
                                    <td class="text-center" colspan="4"><i class="fa fa-spinner fa-spin" style="font-size:2rem"></i>
                                    </td>
                                </tr>
                                
                                {% else %}
                                <tr>
                                    <td colspan="4" style="text-align: center;">No Record Found...</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- *************************************Modal********************************** -->
    <div class="overlayModal" id="addOrganisationModal" data-keyboard="false" data-backdrop="static">

    </div>
    <div class="overlayModal" id="addDeptModal" data-keyboard="false" data-backdrop="static">

    </div>
    <!-- *************************************Modal********************************** -->
    {% endblock content %}
    {% block script %}
    
    <script src="{% static 'js/jquery-confirm.min.js' %}"></script>
    <script type="text/javascript">

        
            
        
        $(document).ready(function () {
            var prevTop = 0;
            
            $('#ajax-div').on('scroll', function () {
                var page = $('#page').val();
                var totalPages = $('#total_pages').val();
                
                var currentTop = $(this).scrollTop();
                if (prevTop !== currentTop) {
                    prevTop = currentTop;
                    if ($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {

                        if($('#page_status').val() == 0 && page  <= totalPages){
                            $('#loading').show(); 
                            $('#page_status').val('1');
                            $.ajax({
                                url: "{% url 'src:ajax-organization-lists' %}",
                                method: 'GET',
                                data: { page:page },
                                success: function (data) {
                                    setTimeout(() => {
                                        $('#tablebody').find('tr:last').prev().after(data);
                                        $('#page').val(parseInt(page)+1);
                                        $('#loading').hide();
                                        $('#page_status').val('0');
                                        $('#addOrgTable').trigger('update');
                                    }, 2000);
                                },
                                error: function (err) {
                                    alert(err.message);
                                    window.location.reload();
                                }
                            });
                        }
                    }
                }
            })
            
        });
    </script>
    
    <script>

        function filterVacationList(){
            var loading_html =`<tr id="loading" style="display: none;">
            <td class="text-center" colspan="8"><i class="fa fa-spinner fa-spin" style="font-size:2rem"></i>
            </td>
            </tr>`;
            $('#tablebody').html(loading_html);
            $('#loading').show();
            {% comment %}
            var search = $('#filter_search').val();
            var locality_id = $('#filter_locality_id').val();
            $.ajax({
                url: "{% url 'src:filter-vacations' %}",
                method: 'POST',
                data: {
                    search:search, 
                    locality_id:locality_id,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (data) {
                    hideLoader();
                    $('#ajax-div').html(data);
                },
                error: function (err) {
                    alert(err.message);
                }
            });
            {% endcomment %}
        }
        function getVacationCalender(id,month,year) {
            // {% comment %}
            console.log("1221");
            $('#ajaxCalendarDiv').html(`<div style="margin-top:40px; text-align:center"><i class="fa fa-spinner fa-spin" style="font-size:2rem"></div>`).addClass('calender-container');
            url = "{% url 'src:holidays/customer-vacation-calendar' '1' %}";
            url = url.replace('1',id)
            
            $.ajax({
                url:url,
                method: 'GET',
                data:{month:month,year:year},
                success: function (data) {
                    $('#ajaxCalendarDiv').html(data).removeClass('calender-container');;
                },
                error: function (err) {
                    console.log(err)
                }
            });
            // {% endcomment %}
        }


        function handleTabChange(element,type){
            $('.customer-tab').removeClass('activeTab');
            $(element).addClass('activeTab');
            $('#date_selection_type').val(type);
            $('#range_start_date').val('');
            $('#range_end_date').val('');
            $('.new_vacation').each(function(){
                $(this).prop('checked',false);
                $(this).next().find('div').removeClass('checked_date');

            });

        }

        function updateVacationDates(element){
            var date_selection_type = $('#date_selection_type').val();
            if(date_selection_type == 1){
                $('[name="vacation_date[]"]').each(function(){
                    if($(this).prop('checked')){
                        $(this).addClass('new_vacation');
                        $(this).next().find('div').addClass('checked_date');
                    }else{
                        $(this).addClass('new_vacation');
                        $(this).next().find('div').removeClass('checked_date');
                    }
                });
            }else{
                range_start_date = $('#range_start_date').val();
                range_end_date = $('#range_end_date').val();
                if (range_start_date == "" && range_end_date == ""){
                    $(element).addClass('new_vacation');
                    $(element).next().find('div').addClass('checked_date');
                    $('#range_start_date').val($(element).val());

                    console.log($('#range_start_date').val());
                    console.log($('#range_end_date').val());
                }else if (range_start_date != "" && range_end_date == ""){
                    $(element).addClass('new_vacation');
                    $(element).next().find('div').addClass('checked_date');
                    $('#range_end_date').val($(element).val());

                        // range date selection
                        range_start_date = $('#range_start_date').val();
                        range_end_date = $('#range_end_date').val();
                        
                        console.log(range_start_date);
                        console.log(range_end_date);
                        
                        var daylist = getDaysArray(new Date(range_start_date),new Date(range_end_date));
                        daylist.forEach(element => {

                            date = parseInt(element.getDate())
                            if(date < 10){
                                date = "0"+date;
                            }
                            month = parseInt(element.getMonth()) + 1
                            if(month < 10){
                                month = "0"+month;
                            }
                            var date_element_id = 'date-'+element.getFullYear()+"-"+month+"-"+date;
                            console.log(date_element_id)
                            $('#'+date_element_id).prop('checked',true);
                            $('#'+date_element_id).addClass('new_vacation');
                            $('#'+date_element_id).next().find('div').addClass('checked_date');
                            
                        });
                        
                    }else if (range_start_date != "" && range_end_date != ""){
                        $('#range_start_date').val('');
                        $('#range_end_date').val('');
                        $('.new_vacation').each(function(){
                            $(this).prop('checked',false);
                            $(this).next().find('div').removeClass('checked_date');
                        });
                        $(element).prop('checked',true);
                        $(element).addClass('new_vacation');
                        $(element).next().find('div').addClass('checked_date');
                        $('#range_start_date').val($(element).val());
                    }
                }
            }
            
            function getDaysArray(startDate, endDate) {
                var dates = [],
                currentDate = startDate,
                addDays = function(days) {
                    var date = new Date(this.valueOf());
                    date.setDate(date.getDate() + days);
                    return date;
                };
                while (currentDate <= endDate) {
                    dates.push(currentDate);
                    currentDate = addDays.call(currentDate, 1);
                }
                return dates;
            }
            
            function updateVacation(){
                {% comment %}
                var question = "Do you want to add the vacation for selected days ?";
                $.confirm({
                    title: 'Confirm!',
                    content: question,
                    buttons: {
                        confirm: function () {
                           showLoader();
                           url = "{% url 'src:vacations/update-customer-vacation' %}";
                           $.ajax({
                            url:url,
                            method: 'POST',
                            data:$('#markVacationForm').serialize(),
                            success: function (data) {
                                if(typeof data.flag !== "undefined" && !data.flag){
                                    hideLoader();
                                    openToaster("danger", data.message);
                                }else{
                                    hideLoader();
                                    if(data.flag){
                                        openToaster('success',data.message);
                                        getVacationCalender(data.customer_id,'{{current_month}}','{{current_year}}');
                                    }else{
                                        openToaster('danger',data.message);
                                    }
                                }
                            },
                            error: function (err) {
                                hideLoader();
                                console.log(err)
                            }
                        });
                           
                       },
                       cancel: function () {
                        hideLoader();
                    }
                }
            });
            {% endcomment %}
            }
            
        </script>
        {% endblock %}
